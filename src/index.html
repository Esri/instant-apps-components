<!-- /*
 *   Copyright (c) 2022 Esri
 *   All rights reserved.
 *   Licensed under the Apache License, Version 2.0 (the "License");
 *   you may not use this file except in compliance with the License.
 *   You may obtain a copy of the License at
 *   http://www.apache.org/licenses/LICENSE-2.0
 *   Unless required by applicable law or agreed to in writing, software
 *   distributed under the License is distributed on an "AS IS" BASIS,
 *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *   See the License for the specific language governing permissions and
 *   limitations under the License.
 */ -->

<!DOCTYPE html>
<html dir="ltr" lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0" />
  <title>ArcGIS Online: Instant Apps Components</title>

  <link rel="stylesheet" href="https://jsdev.arcgis.com/4.24/esri/themes/light/main.css" />
  <script src="https://jsdev.arcgis.com/4.24/"></script>

  <link rel="stylesheet" href="../dist/@esri/calcite-components/calcite.css" />
  <script type="module" src="../dist/@esri/calcite-components/calcite.esm.js"></script>
  <script nomodule src="../dist/@esri/calcite-components/calcite.js"></script>
  <script type="module" src="/build/instant-apps-components.esm.js"></script>
  <script nomodule src="/build/instant-apps-components.js"></script>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }

    #viewDiv {
      height: 95%;
    }
  </style>

  </script>
</head>

<body class="calcite-theme-light">
  <instant-apps-header title-text="Instant Apps Components"
    logo-image="https://www.esri.com/content/dam/esrisites/en-us/common/icons/product-logos/arcgis-instant-apps-64.svg">
    <!-- <instant-apps-social-share slot="actions-end" share-button-color="inverse" 
     ></instant-apps-social-share> -->
    <!-- <instant-apps-social-share slot="actions-end" share-button-color="inverse" 
     share-url="https://holistic.mapsdevext.arcgis.com/?appid=962ed75b7ee34af98813e13a682710b0"></instant-apps-social-share> -->
    <instant-apps-social-share slot="actions-end" share-button-color="inverse" scale="s" mode="popover">
    </instant-apps-social-share>
  </instant-apps-header>
  <div id="viewDiv"></div>
  <!-- <script>
      require(["esri/config","esri/WebMap", "esri/views/MapView", "esri/widgets/LayerList", "esri/core/watchUtils"], function (esriConfig, WebMap, MapView, LayerList, watchUtils) {

        const searchParams = new URL(window.location.href).searchParams;

        const center = searchParams.get("center") ? searchParams.get("center").split(";").map(val => parseFloat(val)) : null;
        const zoom = searchParams.get("level") ? parseInt(searchParams.get("level")) : null;
        const hiddenLayers = searchParams.get("hiddenLayers") ? searchParams.get("hiddenLayers").split(";") : null;
        const selectedFeature = searchParams.get("selectedFeature") ? searchParams.get("selectedFeature").split(";") : null
        const selectedFeatureLayerId = selectedFeature ? selectedFeature[0] : null;
        const selectedFeatureOID = selectedFeature ? parseInt(selectedFeature[1]) : null;

         esriConfig.portalUrl = "https://jsapi.maps.arcgis.com"
         const map = new WebMap({
           portalItem: {
             id: "75dc070f2d294aab8fb3364063f14bf1"
           }
         });
         const view = new MapView({
           container: "viewDiv",
           map: map,
           center,
           zoom
         });

          view.map.loadAll().then(loadedMap => {

            if (hiddenLayers) {
              loadedMap.allLayers.forEach(layer => {
                if (hiddenLayers.indexOf(layer.id) !== -1) {
                  layer.visible = false;
                }
              })
            }

          if (selectedFeature) {
            const selectedLayer = loadedMap.allLayers.find(layer => selectedFeatureLayerId === layer.id);
          const query = selectedLayer.createQuery();
          query.objectIds = [selectedFeatureOID];
          selectedLayer.queryFeatures(query).then(featureRes => {
            const feature = featureRes.features[0];
            view.goTo(feature).then(() => {
              view.popup.open({
                features: [feature]
              });
            });
          });
          }
         });



         const layerList = new LayerList({
           view
         });

         view.ui.add(layerList, "bottom-right");

         const socialShare = document.querySelector("instant-apps-social-share");
         socialShare.view = view;
         socialShare.defaultUrlParams = {
           selectedFeature: false,
           hiddenLayers: false
         }
       });
   </script> -->
  <script>
    require(["esri/config", "esri/WebScene", "esri/views/SceneView", "esri/widgets/LayerList", "esri/core/watchUtils", "esri/geometry/projection"], function (esriConfig, WebScene, SceneView, LayerList, watchUtils, projection) {

      // esriConfig.portalUrl = "https://holistic.mapsdevext.arcgis.com";

      const searchParams = new URL(window.location.href).searchParams;

      const viewpoint = searchParams.get("viewpoint");

      let camera;

      if (viewpoint) {
        const viewpointValues = viewpoint.split(':')[1];
        const viewpointArrs = viewpointValues.split(';');
        const parsedViewpointValues = viewpointArrs.map(viewpointArrItem => viewpointArrItem.split(','))
          .map(nestedviewpointArrItem => nestedviewpointArrItem.map(nestedviewpointArrItemVal => parseFloat(nestedviewpointArrItemVal)));
        const [longitude, latitude, z] = parsedViewpointValues[0];
        const [heading, tilt] = parsedViewpointValues[1];
        camera = { heading, position: { longitude, latitude, z }, tilt };
      }




      const map = new WebScene({
        portalItem: {
          id: "7685f7ba6b47426ea20d6f640cf98596"
        }
      });

      const viewConfig = {
        map,
        container: "viewDiv"
      };


      const view = new SceneView(camera ? { ...viewConfig, camera } : viewConfig);

      const layerList = new LayerList({
        view
      });

      const selectedFeature = searchParams.get("selectedFeature") ? searchParams.get("selectedFeature").split(";") : null
      const layerId = selectedFeature ? selectedFeature[0] : null;
      const featureId = selectedFeature ? parseInt(selectedFeature[1]) : null;



      view.when(() => {
        view.map.loadAll().then(() => {
          const layer = view.map.findLayerById(layerId);
          // get the feature
          const query = layer.createQuery();
          query.outFields = ["*"];
          query.objectIds = [featureId];
          query.returnGeometry = true;
          layer.queryFeatures(query).then(results => {
            const {
              features
            } = results;
            console.log("Features", features);
            console.log(features[0].geometry.centroid);
            projection.load().then(function () {
              let centroid = projection.project(features[0].geometry.centroid, view.spatialReference);
              view.popup.open({
                features,
                location: centroid,
                fetchFeatures: true
              })
            });
          });
        })

      })


      const socialShare = document.querySelector("instant-apps-social-share");
      socialShare.view = view;

      view.ui.add(layerList, "bottom-right");
    });
  </script>
</body>

</html>