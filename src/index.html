<!DOCTYPE html>
<html dir="ltr" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0" />
    <title>ArcGIS Online: Instant Apps Components</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.22/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.22/"></script>

    <link rel="stylesheet" href="../dist/@esri/calcite-components/calcite.css" />
    <script type="module" src="../dist/@esri/calcite-components/calcite.esm.js"></script>
    <script nomodule src="../dist/@esri/calcite-components/calcite.js"></script>
    <script type="module" src="/build/instant-apps-components.esm.js"></script>
    <script nomodule src="/build/instant-apps-components.js"></script>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }

      #viewDiv {
        height: 95%;
      }
    </style>

    </script>
  </head>
  <body class="calcite-theme-light">
    <instant-apps-header title-text="Instant Apps Components" logo-image="https://www.esri.com/content/dam/esrisites/en-us/common/icons/product-logos/arcgis-instant-apps-64.svg">
      <instant-apps-social-share slot="actions-end" share-button-color="inverse"></instant-apps-social-share>
    </instant-apps-header>
    <div id="viewDiv"></div>
    <script>
      require(["esri/config","esri/WebMap", "esri/views/MapView", "esri/widgets/LayerList", "esri/core/watchUtils"], function (esriConfig, WebMap, MapView, LayerList, watchUtils) {

        const searchParams = new URL(window.location.href).searchParams;

        const center = searchParams.get("center") ? searchParams.get("center").split(";").map(val => parseFloat(val)) : null;
        const zoom = searchParams.get("level") ? parseInt(searchParams.get("level")) : null;
        const hiddenLayers = searchParams.get("hiddenLayers") ? searchParams.get("hiddenLayers").split(";") : null;
        const selectedFeature = searchParams.get("selectedFeature") ? searchParams.get("selectedFeature").split(";") : null
        const selectedFeatureLayerId = selectedFeature ? selectedFeature[0] : null;
        const selectedFeatureOID = selectedFeature ? parseInt(selectedFeature[1]) : null;

         esriConfig.portalUrl = "https://jsapi.maps.arcgis.com"
         const map = new WebMap({
           portalItem: {
             id: "75dc070f2d294aab8fb3364063f14bf1"
           }
         });
         const view = new MapView({
           container: "viewDiv",
           map: map,
           center,
           zoom
         });

          view.map.loadAll().then(loadedMap => {

            if (hiddenLayers) {
              loadedMap.allLayers.forEach(layer => {
                if (hiddenLayers.indexOf(layer.id) !== -1) {
                  layer.visible = false;
                }
              })
            }

          if (selectedFeature) {
            const selectedLayer = loadedMap.allLayers.find(layer => selectedFeatureLayerId === layer.id);
          const query = selectedLayer.createQuery();
          query.objectIds = [selectedFeatureOID];
          selectedLayer.queryFeatures(query).then(featureRes => {
            const feature = featureRes.features[0];
            view.goTo(feature).then(() => {
              view.popup.open({
                features: [feature]
              });
            });
          });
          }
         });



         const layerList = new LayerList({
           view
         });

         view.ui.add(layerList, "bottom-right");

         const socialShare = document.querySelector("instant-apps-social-share");
         socialShare.view = view;

       });
   </script>
  </body>
</html>
